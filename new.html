<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
		<script src="jquery.maskedinput.min.js"></script>
		<link rel="stylesheet" href="navcalc.css">
		<title>Навигационный калькулятор</title>
	</head>

	<body>
		 <!-- Tab links -->
		<div class="tab">
			<button class="tablinks" onclick="openTab(event, 'DirectProblem')" id="defaultOpen">Прямая задача</button>
			<button class="tablinks" onclick="openTab(event, 'InverseProblem1')">Обратная задача 1</button>
			<button class="tablinks" onclick="openTab(event, 'InverseProblem2')">Обратная задача 2</button>
			<button class="tablinks" onclick="openTab(event, 'Settings')">≡</button>
		</div>

		<!-- Tab content -->
		<div id="DirectProblem" class="tabcontent">
			<div class="block">
				<span class="quantity">Данные о девиации</span>
				<select size="1" id="dir_devtable" class="input_field dev_table">
				</select>
			</div>
			<div class="block">
				<span class="quantity">Магнитное склонение</span>
				<input id="dir_declination" class="input_field" type="number" min="-180" max="180" step=".1" value="16.7" />
			</div>
			<div class="block">
				<span class="quantity">Широта исходной точки</span>
				<input id="dir_lat" class="input_field degmin" type="text" value="69°10.95′" />
			</div>
			<div class="block">
				<span class="quantity">Долгота исходной точки</span>
				<input id="dir_long" class="input_field degmin" type="text" value="36°07.00′" />
			</div>
			<div class="block">
				<span class="quantity">Компасный курс</span>
				<input id="dir_compass_course" class="input_field" type="number" min="0" max="359.99" step=".01" value="25" />
			</div>
			<div class="block">
				<span class="quantity">Скорость хода</span>
				<input id="dir_velocity" class="input_field" type="number" min="0" max="100" step=".1" value="8.0" />
				<span class="unit">уз</span>
			</div>
			<div class="block">
				<span class="quantity">РОЛ</span>
				<input id="dir_log_increment" class="input_field" type="number" min="0" max="100" step=".01" value="5.8" />
				<span class="unit">M</span>
			</div>
			<div class="block">
				<span class="cb_label">Ветер</span>
				<label class="switch">
					<input type="checkbox" id="dir_cb_wind">
					<span class="slider"></span>
				</label>
			</div>
			<div class="block" id="dir_wind">
				<span class="quantity">Направление</span>
				<input id="dir_wind_direction" class="input_field" type="number" min="0" max="359.99" step=".01" value="315" />
			</div>
			<div class="block">
				<span class="cb_label">Течение</span>
				<label class="switch">
					<input type="checkbox" id="dir_cb_stream">
					<span class="slider"></span>
				</label>
			</div>
			<div class="block" id="dir_stream_dir">
				<span class="quantity">Скорость</span>
				<input id="dir_stream_velocity" class="input_field" type="number" min="0" max="100" step=".1" value="3" />
				<span class="unit">уз</span>
			</div>
			<div class="block" id="dir_stream_vel">
				<span class="quantity">Направление</span>
				<input id="dir_stream_direction" class="input_field" type="number" min="0" max="359.99" step=".1" value="112">
			</div>
			<div class="block for_button">
				<button class="wide_button" id="dir_udpate">Рассчитать</button>
			</div>
			<hr>
			<!-- ----------------------------------------------------------------------------------------- -->
			<div class="block valid">
				<span class="a_quantity">Широта конечной точки</span><span id="dir_new_lat" class="answer"></span>
			</div>
			<div class="block valid">
				<span class="a_quantity">Долгота конечной точки</span><span id="dir_new_long" class="answer"></span>
			</div>
			<div class="block valid">
				<span class="a_quantity">Девиация</span><span id="dir_deviation" class="answer"></span>
			</div>
			<div class="block valid">
				<span class="a_quantity">Магнитный курс</span><span id="dir_magnetic_course" class="answer"></span>
			</div>
			<div class="block valid">
				<span class="a_quantity">Истинный курс</span><span id="dir_true_course" class="answer"></span>
			</div>
			<div class="block valid">
				<span class="a_quantity">&alpha;</span><span id="dir_alpha" class="answer"></span>
			</div>
			<div class="block valid">
				<span class="a_quantity">ПУ<sub>&alpha;</sub></span><span id="dir_PUa" class="answer"></span>
			</div>
			<div class="block valid">
				<span class="a_quantity">&beta;</span><span id="dir_beta" class="answer"></span>
			</div>
			<div class="block valid">
				<span class="a_quantity">ПУ<sub>&alpha;&beta;</sub></span><span id="dir_PUab" class="answer"></span>
			</div>
			<div class="block for_button">
				<button class="wide_button" id="dir_useResults">Использовать конечную точку как исходную</button>
			</div>
		</div>

		<div id="InverseProblem1" class="tabcontent">
			<div class="block">
				<span class="quantity">Данные о девиации</span>
				<select size="1" id="inv1_devtable" class="input_field dev_table">
				</select>
			</div>
			<div class="block">
				<span class="quantity">Магнитное склонение</span>
				<input id="inv1_declination" class="input_field" type="number" min="-180" max="180" step=".01" value="16.7" />
			</div>
			<div class="block">
				<span class="quantity">Широта исходной точки</span>
				<input id="inv1_lat" class="input_field degmin" type="text" value="69°10.95′" />
			</div>
			<div class="block">
				<span class="quantity">Долгота исходной точки</span>
				<input id="inv1_long" class="input_field degmin" type="text" value="36°07.00′" />
			</div>
			<div class="block">
				<span class="a_quantity">ПУ<sub>&alpha;&beta;</sub></span>
				<input id="inv1_PUab" class="input_field" type="number" min="0" max="359.99" step=".01" value="64.7" />
			</div>
			<div class="block">
				<span class="quantity">Скорость хода</span>
				<input id="inv1_velocity" class="input_field" type="number" min="0" max="100" step=".1" value="8.0" />
				<span class="unit">уз</span>
			</div>
			<div class="block">
				<span class="quantity">РОЛ</span>
				<input id="inv1_log_increment" class="input_field" type="number" min="0" max="100" step=".01" value="5.8" />
				<span class="unit">M</span>
			</div>
			<div class="block">
				<span class="cb_label">Ветер</span>
				<label class="switch">
					<input type="checkbox" id="inv1_cb_wind">
					<span class="slider"></span>
				</label>
			</div>
			<div class="block" id="inv1_wind">
				<span class="quantity">Направление</span>
				<input id="inv1_wind_direction" class="input_field" type="number" min="0" max="359.99" step=".01" value="315" />
			</div>
			<div class="block">
				<span class="cb_label">Течение</span>
				<label class="switch">
					<input type="checkbox" id="inv1_cb_stream">
					<span class="slider"></span>
				</label>
			</div>
			<div class="block" id="inv1_stream_dir">
				<span class="quantity">Скорость</span>
				<input id="inv1_stream_velocity" class="input_field" type="number" min="0" max="100" step=".1" value="3" />
				<span class="unit">уз</span>
			</div>
			<div class="block" id="inv1_stream_vel">
				<span class="quantity">Направление</span>
				<input id="inv1_stream_direction" class="input_field" type="number" min="0" max="359.99" step=".1" value="112">
			</div>
			<div class="block for_button">
				<button class="wide_button" id="inv1_udpate">Рассчитать</button>
			</div>
			<hr>
			<!-- ----------------------------------------------------------------------------------------- -->
			<div class="block valid">
				<span class="a_quantity">Широта конечной точки</span><span id="inv1_new_lat" class="answer"></span>
			</div>
			<div class="block valid">
				<span class="a_quantity">Долгота конечной точки</span><span id="inv1_new_long" class="answer"></span>
			</div>
			<div class="block valid">
				<span class="a_quantity">Компасный курс</span><span id="inv1_compass_course" class="answer"></span>
			</div>
			<div class="block valid">
				<span class="a_quantity">Девиация</span><span id="inv1_deviation" class="answer"></span>
			</div>
			<div class="block valid">
				<span class="a_quantity">Магнитный курс</span><span id="inv1_magnetic_course" class="answer"></span>
			</div>
			<div class="block valid">
				<span class="a_quantity">Истинный курс</span><span id="inv1_true_course" class="answer"></span>
			</div>
			<div class="block valid">
				<span class="a_quantity">&alpha;</span><span id="inv1_alpha" class="answer"></span>
			</div>
			<div class="block valid">
				<span class="a_quantity">ПУ<sub>&alpha;</sub></span><span id="inv1_PUa" class="answer" />
			</div>
			<div class="block valid">
				<span class="a_quantity">&beta;</span><span id="inv1_beta" class="answer"></span>
			</div>
			<div class="block for_button">
				<button class="wide_button" id="inv1_useResults">Использовать конечную точку как исходную</button>
			</div>
		</div>

		<div id="InverseProblem2" class="tabcontent">
			<div class="block">
				<span class="quantity">Данные о девиации</span>
				<select size="1" id="inv2_devtable" class="input_field dev_table">
				</select>
			</div>
			<div class="block">
				<span class="quantity">Магнитное склонение</span>
				<input id="inv2_declination" class="input_field" type="number" min="-180" max="180" step=".01" value="16.7" />
			</div>
			<div class="block">
				<span class="quantity">Широта исходной точки</span>
				<input id="inv2_lat" class="input_field degmin" type="text" value="69°10.95′" />
			</div>
			<div class="block">
				<span class="quantity">Долгота исходной точки</span>
				<input id="inv2_long" class="input_field degmin" type="text" value="36°07.00′" />
			</div>
			<div class="block">
				<span class="quantity">Широта конечной точки</span>
				<input id="inv2_new_lat" class="input_field degmin" type="text" value="69°13.96′" />
			</div>
			<div class="block">
				<span class="quantity">Долгота конечной точки</span>
				<input id="inv2_new_long" class="input_field degmin" type="text" value="36°24.96′" />
			</div>
			<div class="block">
				<span class="quantity">Скорость хода</span>
				<input id="inv2_velocity" class="input_field" type="number" min="0" max="100" step=".1" value="8.0" />
				<span class="unit">уз</span>
			</div>
			<div class="block">
				<span class="cb_label">Ветер</span>
				<label class="switch">
					<input type="checkbox" id="inv2_cb_wind">
					<span class="slider"></span>
				</label>
			</div>
			<div class="block" id="inv2_wind">
				<span class="quantity">Направление</span>
				<input id="inv2_wind_direction" class="input_field" type="number" min="0" max="359.99" step=".01" value="315" />
			</div>
			<div class="block">
				<span class="cb_label">Течение</span>
				<label class="switch">
					<input type="checkbox" id="inv2_cb_stream">
					<span class="slider"></span>
				</label>
			</div>
			<div class="block" id="inv2_stream_dir">
				<span class="quantity">Скорость</span>
				<input id="inv2_stream_velocity" class="input_field" type="number" min="0" max="100" step=".1" value="3" />
				<span class="unit">уз</span>
			</div>
			<div class="block" id="inv2_stream_vel">
				<span class="quantity">Направление</span>
				<input id="inv2_stream_direction" class="input_field" type="number" min="0" max="359.99" step=".1" value="112">
			</div>
			<div class="block for_button">
				<button class="wide_button" id="inv2_udpate">Рассчитать</button>
			</div>
			<hr>
			<!-- ----------------------------------------------------------------------------------------- -->
			<div class="block valid">
				<span class="a_quantity">Компасный курс</span><span id="inv2_compass_course" class="answer"></span>
			</div>
			<div class="block valid">
				<span class="a_quantity">Девиация</span><span id="inv2_deviation" class="answer"></span>
			</div>
			<div class="block valid">
				<span class="a_quantity">Магнитный курс</span><span id="inv2_magnetic_course" class="answer"></span>
			</div>
			<div class="block valid">
				<span class="a_quantity">Истинный курс</span><span id="inv2_true_course" class="answer"></span>
			</div>
			<div class="block valid">
				<span class="a_quantity">&alpha;</span><span id="inv2_alpha" class="answer"></span>
			</div>
			<div class="block valid">
				<span class="a_quantity">ПУ<sub>&alpha;</sub></span><span id="inv2_PUa" class="answer"></span>
			</div>
			<div class="block valid">
				<span class="a_quantity">&beta;</span><span id="inv2_beta" class="answer"></span>
			</div>
			<div class="block valid">
				<span class="a_quantity">ПУ<sub>&alpha;&beta;</sub></span><span id="inv2_PUab" class="answer"></span>
			</div>
			<div class="block valid">
				<span class="a_quantity">РОЛ</span><span id="inv2_log_increment" class="answer"></span>
			</div>
			<div class="block for_button">
				<button class="wide_button" id="inv2_useResults">Использовать конечную точку как исходную</button>
			</div>
		</div> 

		<div id="Settings" class="tabcontent">
			<div class="block for_button">
				<h1>Таблицы девиации</h1>
			</div>
			<div id="set_dev_tables" >
			</div>

			<div class="block for_button">
				<h1>Курсы и дрейф</h1>
			</div>
			<div id="set_drift_tables">
				<!--table>
					<tr class="ctr"><th class="course">Курс</th>						<th>Дрейф</th>																	<th colspan="2">Угол к ветру</th> </tr>
					<tr class="ctr"><td class="course gray" rowspan="2">Левентик</td>	<td class="drift gray" rowspan="2" contenteditable inputmode="numeric">8</td>	<td class="more gray">≥</td>	<td class="ctw first">0</td> </tr>	
					<tr class="ctr">																																	<td class="less gray"><</td>	<td class="ctw" rowspan="2" contenteditable inputmode="numeric">20</td></tr>
					<tr class="ctr"><td class="course" rowspan="2">Бейдевинд</td>		<td class="drift" rowspan="2" contenteditable inputmode="numeric">8</td>		<td class="more">≥</td> </tr>
					<tr class="ctr">																																	<td class="less"><</td>	<td class="ctw" rowspan="2" contenteditable inputmode="numeric">80</td></tr>
					<tr class="ctr"><td class="course gray" rowspan="2">Галфвинд</td>	<td class="drift gray" rowspan="2" contenteditable inputmode="numeric">4</td>	<td class="more gray">≥</td>	</tr>
					<tr class="ctr">																																	<td class="less gray"><</td>	<td class="ctw" rowspan="2" contenteditable inputmode="numeric">100</td></tr>
					<tr class="ctr"><td class="course" rowspan="2">Бакштаг</td>			<td class="drift" rowspan="2" contenteditable inputmode="numeric">2</td>		<td class="more">≥</td> </tr>	
					<tr class="ctr">																																	<td class="less"><</td>	<td class="ctw" rowspan="2" contenteditable inputmode="numeric">160</td></tr>
					<tr class="ctr"><td class="course gray" rowspan="2">Фордевинд</td>	<td class="drift gray" rowspan="2" contenteditable inputmode="numeric">0</td>	<td class="more gray">≥</td> </tr>
					<tr class="ctr">																																	<td class="less gray">≤</td>	<td class="ctw last">180</td></tr>
				</table-->
			</div>

			<div class="modal" id="new_dev">
				<div class="modal-header" id="new_dev_header">
				</div>
				<div class="modal-content" id="new_dev_table">
				</div>
				<div class="modal-footer" id="new_dev_footer">
				</div>
			</div>

			<div class="modal" id="new_drift">
				<div class="modal-header" id="new_drift_header">
				</div>
				<div class="modal-content" id="new_drift_table">
				</div>
				<div class="modal-footer" id="new_drift_footer">
				</div>
			</div>

			

		</div>

		<script src="calculations.js"></script>

		<script>
			"use strict"
			
			let devTables = [
				{tag: "Нет", data: [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
						0.0, 0.0,0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
						0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]},
				{tag: "Табл. №1", data: [-2.50, -0.50, 1.6, 4.4, 7.6, 11.1, 14, 16.5, 18.7, 20.1, 20.8, 19.4,
						16.7, 13.4, 9.8, 6.9, 4.6, 2.5, 1.1, 0.9, -1.20, -3.30, -6.50, -10.30, -13.20, -15.70,
						-17.90, -19.20, -18.10, -16.20, -13.90, -10.60, -8.30, -6.20, -4.40, -2.90, -2.50,
						-0.50]}, 
				{tag: "Табл. №2", data: [-2.5, -2.2, -2.1, -2.2, -2.4, -2.8, -3.4, -4.1, -4.7, -5.3, -5.6, -5.7, -5.4, -4.7, 
						-3.6, -2.3, -0.7, 0.9, 2.6, 4.0, 5.2, 6.0, 6.4, 6.3, 5.7, 4.8, 3.7, 2.4, 1.0, -0.2, -1.2,
						-2.0, -2.6, -2.8, -2.8, -2.7, -2.5, -2.2]},
				{tag: "Табл. №2.1", data: [3.2, 2.4, 1.8, 1.4, 0.7, 0.0, -1, -2.1, -2.8, -3.8, -4.6, -5.2, -5.6, -6.0, 
							-5.7, -5.2, -4.6, -3.5, -2.4, -1.0, 0.4, 1.8, 2.8, 3.8, 4.9, 5.6, 6.0, 6.3, 
							6.4, 6.0, 5.6, 5.2, 4.6, 4.2, 3.8, 3.5, 3.2, 3.4]}
			];

			let driftTables = [
				{
					tag: "8-8-4-2",
					drift: {nogo: 8, close: 8, beam: 4, broad: 2, downwind: 0},
					boundaries: {nogo: 20, close: 80, beam: 100, broad: 160}
				}
			];
			
			function dir_UpdateAnswers() {
				let declination = parseFloat($("#dir_declination")[0].value);
				let latText = $("#dir_lat")[0].value;
				let longText = $("#dir_long")[0].value;
				
				let re = /([0-9]{2})°([0-5][0-9].[0-9]{2})′/;
				let latitude = latText.match(re).slice(1,3).map(x => parseFloat(x)).toDegrees();
				let longitude = longText.match(re).slice(1,3).map(x => parseFloat(x)).toDegrees();

				let compassCourse = parseFloat($("#dir_compass_course")[0].value);
				let velocity = parseFloat($("#dir_velocity")[0].value);
				let logIncrement = parseFloat($("#dir_log_increment")[0].value);
				let windDirection = parseFloat($("#dir_wind_direction")[0].value);
				let streamDirection = parseFloat($("#dir_stream_direction")[0].value);
				let streamVelocity = parseFloat($("#dir_stream_velocity")[0].value);
				
				let [newLat, newLong, deviation, magneticCourse, trueCourse, alpha, pua, beta, puab] = 
					directProblem(declination, latitude, longitude, compassCourse, velocity, logIncrement,
						windDirection, streamVelocity, streamDirection, $("#dir_cb_wind")[0].checked, $("#dir_cb_stream")[0].checked, 
						devTables[$("#dir_devtable")[0].selectedIndex].data);
			
				$("#dir_new_lat")[0].innerHTML = newLat.toDMText();
				$("#dir_new_long")[0].innerHTML = newLong.toDMText();
				$("#dir_deviation")[0].innerHTML = deviation.toFixed(1).toString();
				$("#dir_magnetic_course")[0].innerHTML = magneticCourse.toFixed(1).toString();
				$("#dir_true_course")[0].innerHTML = trueCourse.toFixed(1).toString();
				$("#dir_alpha")[0].innerHTML = alpha.toFixed(1).toString();
				$("#dir_PUa")[0].innerHTML = pua.toFixed(1).toString();
				$("#dir_beta")[0].innerHTML = beta.toFixed(1).toString();
				$("#dir_PUab")[0].innerHTML = puab.toFixed(1).toString();

				answersSetState("#DirectProblem", "valid");
			}

			function dir_CbWindChange (){
				$("#dir_wind").children().prop('disabled', !$("#dir_cb_wind")[0].checked);
				answersSetState("#DirectProblem", "invalid");
			}

			function dir_CbStreamChange (){
				$("#dir_stream_dir").children().prop('disabled', !$("#dir_cb_stream")[0].checked);
				$("#dir_stream_vel").children().prop('disabled', !$("#dir_cb_stream")[0].checked);
				answersSetState("#DirectProblem", "invalid");
			}

			function inv1_UpdateAnswers() {
				let declination = parseFloat($("#inv1_declination")[0].value);
				let latText = $("#inv1_lat")[0].value;
				let longText = $("#inv1_long")[0].value;
				
				let re = /([0-9]{2})°([0-5][0-9].[0-9]{2})′/;
				let latitude = latText.match(re).slice(1,3).map(x => parseFloat(x)).toDegrees();
				let longitude = longText.match(re).slice(1,3).map(x => parseFloat(x)).toDegrees();

				let PUab = parseFloat($("#inv1_PUab")[0].value);
				let velocity = parseFloat($("#inv1_velocity")[0].value);
				let logIncrement = parseFloat($("#inv1_log_increment")[0].value);
				let windDirection = parseFloat($("#inv1_wind_direction")[0].value);
				let streamDirection = parseFloat($("#inv1_stream_direction")[0].value);
				let streamVelocity = parseFloat($("#inv1_stream_velocity")[0].value);
				
				let [newLat, newLong, compassCourse, deviation, magneticCourse, trueCourse, alpha, pua, beta] = 
					inverseProblem1(declination, latitude, longitude, PUab, velocity, logIncrement,
						windDirection, streamVelocity, streamDirection, $("#inv1_cb_wind")[0].checked, $("#inv1_cb_stream")[0].checked,
						devTables[$("#inv1_devtable")[0].selectedIndex].data);

				$("#inv1_new_lat")[0].innerHTML = newLat.toDMText();
				$("#inv1_new_long")[0].innerHTML = newLong.toDMText();
				$("#inv1_compass_course")[0].innerHTML = compassCourse.toFixed(1).toString();
				$("#inv1_deviation")[0].innerHTML = deviation.toFixed(1).toString();
				$("#inv1_magnetic_course")[0].innerHTML = magneticCourse.toFixed(1).toString();
				$("#inv1_true_course")[0].innerHTML = trueCourse.toFixed(1).toString();
				$("#inv1_alpha")[0].innerHTML = alpha.toFixed(1).toString();
				$("#inv1_PUa")[0].innerHTML = pua.toFixed(1).toString();
				$("#inv1_beta")[0].innerHTML = beta.toFixed(1).toString();
				
				answersSetState("#InverseProblem1", "valid");
			}

			function inv1_CbWindChange (){
				$("#inv1_wind").children().prop('disabled', !$("#inv1_cb_wind")[0].checked);
				answersSetState("#InverseProblem1", "invalid");
			}

			function inv1_CbStreamChange (){
				$("#inv1_stream_dir").children().prop('disabled', !$("#inv1_cb_stream")[0].checked);
				$("#inv1_stream_vel").children().prop('disabled', !$("#inv1_cb_stream")[0].checked);
				answersSetState("#InverseProblem1", "invalid");
			}

			function inv2_UpdateAnswers() {
				let declination = parseFloat($("#inv2_declination")[0].value);
				
				let re = /([0-9]{2})°([0-5][0-9].[0-9]{2})′/;
				let latitude = $("#inv2_lat")[0].value.match(re).slice(1,3).map(x => parseFloat(x)).toDegrees();
				let longitude = $("#inv2_long")[0].value.match(re).slice(1,3).map(x => parseFloat(x)).toDegrees();
				
				let newLat = $("#inv2_new_lat")[0].value.match(re).slice(1,3).map(x => parseFloat(x)).toDegrees();
				let newLong = $("#inv2_new_long")[0].value.match(re).slice(1,3).map(x => parseFloat(x)).toDegrees();

				let PUab = parseFloat($("#inv2_PUab")[0].value);
				let velocity = parseFloat($("#inv2_velocity")[0].value);
				let windDirection = parseFloat($("#inv2_wind_direction")[0].value);
				let streamDirection = parseFloat($("#inv2_stream_direction")[0].value);
				let streamVelocity = parseFloat($("#inv2_stream_velocity")[0].value);
				
				let [compassCourse, deviation, magneticCourse, trueCourse, alpha, pua, beta, puab, logIncrement] = 
					inverseProblem2(declination, latitude, longitude, newLat, newLong, velocity, 
						windDirection, streamVelocity, streamDirection, $("#inv2_cb_wind")[0].checked, $("#inv2_cb_stream")[0].checked,
						devTables[$("#inv2_devtable")[0].selectedIndex].data);

				$("#inv2_compass_course")[0].innerHTML = compassCourse.toFixed(1).toString();
				$("#inv2_deviation")[0].innerHTML = deviation.toFixed(1).toString();
				$("#inv2_magnetic_course")[0].innerHTML = magneticCourse.toFixed(1).toString();
				$("#inv2_true_course")[0].innerHTML = trueCourse.toFixed(1).toString();
				$("#inv2_alpha")[0].innerHTML = alpha.toFixed(1).toString();
				$("#inv2_PUa")[0].innerHTML = pua.toFixed(1).toString();
				$("#inv2_beta")[0].innerHTML = beta.toFixed(1).toString();
				$("#inv2_PUab")[0].innerHTML = puab.toFixed(1).toString();
				$("#inv2_log_increment")[0].innerHTML = logIncrement.toFixed(1).toString();

				answersSetState("#InverseProblem2", "valid");
			}

			function inv2_CbWindChange (){
				$("#inv2_wind").children().prop('disabled', !$("#inv2_cb_wind")[0].checked);
				answersSetState("#InverseProblem2", "invalid");
			}

			function inv2_CbStreamChange (){
				$("#inv2_stream_dir").children().prop('disabled', !$("#inv2_cb_stream")[0].checked);
				$("#inv2_stream_vel").children().prop('disabled', !$("#inv2_cb_stream")[0].checked);
				answersSetState("#InverseProblem2", "invalid");
			}
			
			function openTab(evt, problemName) {
				// Declare all variables
				var i, tabcontent, tablinks;

				// Get all elements with class="tabcontent" and hide them
				tabcontent = document.getElementsByClassName("tabcontent");
				for (i = 0; i < tabcontent.length; i++) {
					tabcontent[i].style.display = "none";
				}

				// Get all elements with class="tablinks" and remove the class "active"
				tablinks = document.getElementsByClassName("tablinks");
				for (i = 0; i < tablinks.length; i++) {
					tablinks[i].className = tablinks[i].className.replace(" active", "");
				}

				// Show the current tab, and add an "active" class to the button that opened the tab
				document.getElementById(problemName).style.display = "block";
				evt.currentTarget.className += " active";
			}
			

			function drawDriftTable(t, editable=true) {
				let s = '';
				s += '<table><tr class="ctr"><th class="course">Курс</th><th>Дрейф</th><th colspan="2">Углы к ветру</th></tr>\
						<tr class="ctr"><td class="course gray" rowspan="2">Левентик</td><td id="drift-nogo" class="drift gray" rowspan="2" contenteditable=' 
					+ editable.toString() + ' inputmode="numeric">'
					+ t.drift.nogo.toString()
					+ '</td><td class="more gray">≥</td><td class="ctw first">0</td></tr>\
						<tr class="ctr"><td class="less gray"><</td><td id="boundary-nogo" class="ctw" rowspan="2" contenteditable=' 
					+ editable.toString() + ' inputmode="numeric">'
					+ t.boundaries.nogo.toString()
					+ '</td></tr><tr class="ctr"><td class="course" rowspan="2">Бейдевинд</td><td id="drift-close" class="drift" rowspan="2" contenteditable=' 
					+ editable.toString() + ' inputmode="numeric">'
					+ t.drift.close.toString()
					+ '</td><td class="more">≥</td></tr><tr class="ctr"><td class="less"><</td><td id="boundary-close" class="ctw" rowspan="2" contenteditable=' 
					+ editable.toString() + ' inputmode="numeric">'
					+ t.boundaries.close.toString()
					+ '</td></tr><tr class="ctr"><td class="course gray" rowspan="2">Галфвинд</td><td id="drift-beam" class="drift gray" rowspan="2" contenteditable=' 
					+ editable.toString() + ' inputmode="numeric">'
					+ t.drift.beam.toString()
					+ '</td><td class="more gray">≥</td></tr><tr class="ctr"><td class="less gray"><</td><td id="boundary-beam" class="ctw" rowspan="2" contenteditable=' 
					+ editable.toString() + ' inputmode="numeric">'
					+ t.boundaries.beam.toString()
					+ '</td></tr><tr class="ctr"><td class="course" rowspan="2">Бакштаг</td><td id="drift-broad" class="drift" rowspan="2" contenteditable=' 
					+ editable.toString() + ' inputmode="numeric">'
					+ t.drift.broad.toString()
					+ '</td><td class="more">≥</td></tr><tr class="ctr"><td class="less"><</td>	<td id="boundary-broad" class="ctw" rowspan="2" contenteditable=' 
					+ editable.toString() + ' inputmode="numeric">'
					+ t.boundaries.broad.toString()
					+ '</td></tr><tr class="ctr"><td class="course gray" rowspan="2">Фордевинд</td>	<td id="drift-downwind" class="drift gray" rowspan="2" contenteditable=' 
					+ editable.toString() + ' inputmode="numeric">'
					+ t.drift.downwind.toString()
					+ '</td><td class="more gray">≥</td></tr><tr class="ctr"><td class="less gray">≤</td><td class="ctw last">180</td></tr></table>'
					return s;
			}
			
			function parseDriftTable() {
				let div = $("#new_drift_table");
				let t = {
					tag: $("#drift_new_name").val(),
					drift: {
						nogo: Number(div.find("#drift-nogo").text()), 
						close: Number(div.find("#drift-close").text()), 
						beam: Number(div.find("#drift-beam").text()), 
						broad: Number(div.find("#drift-broad").text()), 
						downwind: Number(div.find("#drift-downwind").text())
					},
					boundaries: {
						nogo: Number(div.find("#boundary-nogo").text()), 
						close: Number(div.find("#boundary-close").text()), 
						beam: Number(div.find("#boundary-beam").text()), 
						broad: Number(div.find("#boundary-broad").text()) 
					}
					
				}
				
				let result = true;
				for (let [key, value] of Object.entries(t.drift)) {
					if (isNaN(value)) {
						result = false;
						//
					}
				}
				for (let [key, value] of Object.entries(t.boundaries)) {
					if (isNaN(value)) {
						result = false;
						//
					}
				}
				
				console.log(t)
				return [result, t];
			}
			
			function drawDriftTables() {
				let s = "";
				for (let i = 0; i < driftTables.length; i++) {
					s += '<div class="block for_button" style="height:auto; ">'
					if (i > 0) {s += ' <button tag="' + i.toString() + '" class="drift_remove wide_button cross_button" >&times;</button>';}
					s += '<button type="button" class="wide_button collapsible"  >+ ' + driftTables[i].tag + '</button>';
					s += '<div class="content">';
					s += drawDriftTable(driftTables[i], false);
					s += '</div>';
					s += '</div>'
				}
				s += '<div class="block for_button"><button id="drift_add" class="wide_button">Добавить</button></div>';
				$("#set_drift_tables")[0].innerHTML = s;

				driftModalMess();
				
				let removeBtns = $(".drift_remove");
				for (let item of removeBtns) {
					item.onclick = function() {
						console.log(this.attributes.getNamedItem("tag").value);
						let i = this.attributes.getNamedItem("tag").value;
						driftTables.splice(i, 1);
						drawDriftTables();
						//setupDevSelectors();
					}
				}
				
				let coll = $(".collapsible");
				for (let item of coll) {
					item.onclick = function () {
						this.classList.toggle("active");
						let content = this.nextElementSibling;
						if (content.style.display === "block") {
							content.style.display = "none";
							this.textContent = this.textContent.replace(/^\–/, '+');
						} else {
							content.style.display = "block";
							this.textContent = this.textContent.replace(/^\+/, '–');
						}
					}
				}
			}

			function driftModalMess() {
				let modalBtn = document.getElementById("drift_add")
				let modalTable = $("#new_drift")[0];
				modalBtn.onclick = function(){
					$("#new_drift_header")[0].innerHTML = "Новая таблица дрейфа";
					
					$("#new_drift_table")[0].innerHTML = 
						'<div class="tablename-container"> \
							<label for="drift_new_name" class=explanation style="margin: auto 20px auto auto;">Название:</label> \
							<input class="tablename-input" id="drift_new_name" type="text" /> \
						</div> \
						<div class="explanation" style="margin: 20px auto 20px auto;">Можно менять углы дрейфа и границы между курсами:</div><div id="drifts">'
						+ drawDriftTable(driftTables[0]) + '</div>'; 
					
					$("#new_drift_footer")[0].innerHTML = '<div><button class="just_button" style="margin-right:20px" id="drift-save">Сохранить</button>'
						+ '<button class="just_button" id="drift-cancel">Отмена</button></div>';

					$("#drift-cancel")[0].onclick = function() {
						modalTable.style.display = "none";
					}
					$("#drift-save")[0].onclick = function() {
						let [ok, table] = parseDriftTable();
						if (ok) {
							modalTable.style.display = "none";
							driftTables[driftTables.length] = table;
							//setupDevSelectors(-1);
							drawDriftTables(table);
							driftModalMess();
						}
					}
					modalTable.style.display = "block"
				}
				
			}

			

			
			function drawDevTable(table, editable=false) {
				let s = '<table>';
				// Each table contains 36 rows plus 2 extra rows which are repeated row0 and row1
				let maxIndex = (table.data.length - 2) / 2;
				for (let j = 0; j < maxIndex; j++) {
					s += '<tr class="dtr"><td class="dtc">' + (j * 10).toString() + '</td><td class="dtc">' 
						+ table.data[j].toFixed(1).toString() + '</td><td class="dtc">'  
						+ ((maxIndex + j) * 10).toString() + '</td><td class="dtc">' + table.data[maxIndex + j].toFixed(1).toString() + '</td></tr>';
				}
				s += '</table>';
				return s;
			}
			
			function drawDevTables() {
				let s = "";
				for (let i = 1; i < devTables.length; i++) {
					s += '<div class="block for_button" style="height:auto; ">'
					if (i > 3) {s += ' <button tag="' + i.toString() + '" class="dev_remove wide_button cross_button" >&times;</button>';}
					s += '<button type="button" class="wide_button collapsible"  >+ ' + devTables[i].tag + '</button>';
					s += '<div class="content">';
					s += drawDevTable(devTables[i]);
					s += '</div>';
					s += '</div>'

				}
				s += '<div class="block for_button"><button id="dev_add" class="wide_button">Добавить</button></div>';
				
				$("#set_dev_tables")[0].innerHTML = s;
				
				devModalMess();
				
				let removeBtns = $(".dev_remove");
				for (let item of removeBtns) {
					item.onclick = function() {
						console.log(this.attributes.getNamedItem("tag").value);
						let i = this.attributes.getNamedItem("tag").value;
						devTables.splice(i, 1);
						drawDevTables();
						setupDevSelectors();
					}
				}
				
				let coll = $(".collapsible");
				for (let item of coll) {
					item.onclick = function () {
						this.classList.toggle("active");
						let content = this.nextElementSibling;
						if (content.style.display === "block") {
							content.style.display = "none";
							this.textContent = this.textContent.replace(/^\–/, '+');
						} else {
							content.style.display = "block";
							this.textContent = this.textContent.replace(/^\+/, '–');
						}
					}
				}
			}

			window.mobileAndTabletCheck = function() {
				let check = false;
				(function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
				return check;
			};
			
			function setupDevSelectors(selIndex = -1) {
				let dropboxes = $(".dev_table");
				for (let item of dropboxes) {
					let si = item.selectedIndex;
					for (let i = item.length - 1; i >= 0; i--) {
						item.options[i] = null;
					}
					for (let i = 0; i < devTables.length; i++) {
						let opt = new Option(i + 1, i);
						opt.text = devTables[i].tag;
						item.options[item.options.length] = opt;
					}
					let nsi =  (si >= item.options.length) ? 0 : si;
					if (selIndex >= item.options.length) {
						selIndex = 0;
					}
					item.selectedIndex = (selIndex > -1) ? selIndex : nsi;
					if (nsi != si) {
						invalidateAnswers();
					}
				}
			}
			
			function invalidateAnswers() {
				for (let item of $(".block.valid")) {
					item.classList.remove("valid");
					item.classList.add("invalid");
				}
			}
		
			function answersSetState(tabID, state) {
				let blocks = $(tabID).find(".block.invalid")
				for (let item of blocks) {
					item.classList.remove("invalid");
					item.classList.add(state);
				}
				blocks = $(tabID).find(".block.valid")
				for (let item of blocks) {
					item.classList.remove("valid");
					item.classList.add(state);
				}
			}
		
			function mobileCheck() {
				if (!window.mobileAndTabletCheck()) {
					for (let item of $(".tab")) {item.setAttribute("style", "width:40%;");}
					for (let item of $(".tab button")) {item.setAttribute("style", "font-size:80%;");}
					for (let item of $(".tabcontent")) {item.setAttribute("style", "width:40%; font-size:100%;");}
					for (let item of $(".block")) {item.setAttribute("style", "height:30px; ");}
					for (let item of $(".block.for_button")) {item.setAttribute("style", "height:auto; ");}
					for (let item of $(".quantity")) {item.setAttribute("style", "width:40%;");}
					for (let item of $(".a_quantity")) {item.setAttribute("style", "width:40%;");}
					for (let item of $(".cb_label")) {item.setAttribute("style", "width:15%;");}
					for (let item of $(".cb")) {item.setAttribute('style', 'top:20%; zoom:1.5; transform:scale(1.5); -ms-transform:scale(1.5); \
								-webkit-transform:scale(1.5); -o-transform:scale(1.5); -moz-transform:scale(1.5)');}
				}	
			}

			mobileCheck();
				

			$(function(){
				$(document).on('click','input[type=text]',function(){ this.select(); });
			});

			$(function(){
				$(document).on('click','input[type=number]',function(){ this.select(); });
			});

			$(function(){
				$(document).on('click','.ctw:not(.first, .last), .drift',function(){ document.execCommand('selectAll',false,null); });
			});

			/*$(function(){
				for (let item of $(".ctw")) {
					item.onclick = function(){ document.execCommand('selectAll',false,null)}
				}
			});

			$(function(){
				for (let item of $(".drift")) {
					item.onclick = function(){ this.select(); }
				}
			});*/

			$(function() {
				$.mask.definitions['m'] = '[0-5]';
				$(".degmin").mask("99°m9.99′");
			});
						
			setupDevSelectors(1);
			
			for (let item of $("#DirectProblem").find(".input_field")) {
				item.onchange = function() {
						answersSetState("#DirectProblem", "invalid");
					}
			}

			for (let item of $("#InverseProblem1").find(".input_field")) {
				item.onchange = function() {
						answersSetState("#InverseProblem1", "invalid");
					}
			}

			for (let item of $("#InverseProblem2").find(".input_field")) {
				item.onchange = function() {
						answersSetState("#InverseProblem2", "invalid");
					}
			}

			for (let item of $(".dev_table")) {
				item.onchange = function() {
						setupDevSelectors(this.selectedIndex);
						invalidateAnswers();
					}
			}
			
			$("#dir_udpate")[0].onclick = dir_UpdateAnswers;
			$("#inv1_udpate")[0].onclick = inv1_UpdateAnswers;
			$("#inv2_udpate")[0].onclick = inv2_UpdateAnswers;
			

			dir_CbWindChange();
			dir_CbStreamChange();
			$("#dir_cb_wind")[0].onchange = dir_CbWindChange;
			$("#dir_cb_wind").click();
			$("#dir_cb_stream")[0].onchange = dir_CbStreamChange;
			$("#dir_cb_stream").click();
			dir_UpdateAnswers();

			inv1_CbWindChange();
			inv1_CbStreamChange();
			$("#inv1_cb_wind")[0].onchange = inv1_CbWindChange;
			$("#inv1_cb_wind").click();
			$("#inv1_cb_stream")[0].onchange = inv1_CbStreamChange;
			$("#inv1_cb_stream").click();
			inv1_UpdateAnswers();
			
			inv2_CbWindChange();
			inv2_CbStreamChange();
			$("#inv2_cb_wind")[0].onchange = inv2_CbWindChange;
			$("#inv2_cb_wind").click();
			$("#inv2_cb_stream")[0].onchange = inv2_CbStreamChange;
			$("#inv2_cb_stream").click();
			inv2_UpdateAnswers();
			
			drawDevTables();
			devModalMess();
			
			drawDriftTables();
			
			$("#dir_useResults")[0].onclick = function() {
				let lat = $("#dir_new_lat").text();
				let long = $("#dir_new_long").text();

				if ((lat == 'NaN') || (long == 'NaN')) {
					console.log("return")
					return;
				}

				$("#dir_lat").val(lat);
				$("#inv1_lat").val(lat);
				$("#inv2_lat").val(lat);

				$("#dir_long").val(long);
				$("#inv1_long").val(long);
				$("#inv2_long").val(long);
				invalidateAnswers();
			}
 			
			$("#inv1_useResults")[0].onclick = function() {
				let lat = $("#inv1_new_lat").text();
				let long = $("#inv1_new_long").text();

				if ((lat == 'NaN') || (long == 'NaN')) {
					console.log("return")
					return;
				}

				$("#dir_lat").val(lat);
				$("#inv1_lat").val(lat);
				$("#inv2_lat").val(lat);

				$("#dir_long").val(long);
				$("#inv1_long").val(long);
				$("#inv2_long").val(long);
				invalidateAnswers();
			}
 			
			$("#inv2_useResults")[0].onclick = function() {
				let lat = $("#inv2_new_lat").val();
				let long = $("#inv2_new_long").val();
				
				if ((lat == 'NaN') || (long == 'NaN')) {
					console.log("return")
					return;
				}
					
				$("#dir_lat").val(lat);
				$("#inv1_lat").val(lat);
				$("#inv2_lat").val(lat);

				$("#dir_long").val(long);
				$("#inv1_long").val(long);
				$("#inv2_long").val(long);
				invalidateAnswers();
			}
 			

			document.getElementById("defaultOpen").click();

			function devModalMess() {
				let modalBtn = document.getElementById("dev_add")
				let modalDevTable = $("#new_dev")[0];
				modalBtn.onclick = function(){
					$("#new_dev_header")[0].innerHTML = "Новая таблица девиации";
					$("#new_dev_table")[0].innerHTML = 
						'<div class="tablename-container"> \
							<label for="dev_new_name" class=explanation style="margin: auto 20px auto auto;">Название:</label> \
							<input class="tablename-input" id="dev_new_name" type="text" /> \
						</div> \
						<div class="explanation" style="margin: 20px auto 20px auto;">36 значений девиации через 10° от 0° до 350° через пробел:</div> \
						<div id="deviations" contenteditable inputmode="numeric" class="tabledata-textarea" ></div>'; 
					$("#new_dev_footer")[0].innerHTML = '<div><button class="just_button" style="margin-right:20px" id="dev-save">Сохранить</button>'
						+ '<button class="just_button" id="dev-cancel">Отмена</button></div>';

					$("#dev-cancel")[0].onclick = function() {
						modalDevTable.style.display = "none";
					}
					$("#dev-save")[0].onclick = function() {
						let [ok, table] = parseDevTable($("#new_dev_table")[0].innerHTML);
						if (ok) {
							modalDevTable.style.display = "none";
							devTables[devTables.length] = {tag: $("#dev_new_name")[0].value, data: table};
							setupDevSelectors(-1);
							drawDevTables();
							devModalMess();
						}
					}
					modalDevTable.style.display = "block"
				}
				
			}
			
			function parseDevTable(html) {
				let deviations = $("#deviations")[0].textContent.replace(/\s*$/, '').split(/\s+/);
				let s = "";
				let valid = true;
				for (let i = 0; i < deviations.length; i++) {
					let ds;
					if (isNaN(deviations[i]) || (i > 35)) {
						valid = false;
						ds = '<span style="background-color:#f88;">' + deviations[i].toString() + '</span> ' 
					} else {
						ds = deviations[i].toString() + ' ';
					}
					s += ds;
				}
				for (let i = deviations.length; i < 36; i++) {
					s += NaN.toString() + ' ';
					valid = false;
				}
				$("#deviations")[0].innerHTML = s;
				
				let result = deviations.map(parseFloat);
				result.push(result[0]);
				result.push(result[1]);
				return [valid, result];
			}
			
		</script>

	</body>
</html>
